"use strict";angular.module("chayka-auth").factory("facebook",["ajax","auth","nls",function(a,b,c){var d={$scope:null,notAuthorized:!1,FB:null,currentUser:window.Chayka.Users.currentUser,getFB:function(){return!d.FB&&window.FB&&(d.FB=window.FB,d.FB.Event.subscribe("auth.authResponseChange",d.onStatusChanged)),d.FB},logout:function(){d.getFB()&&d.getFbUserId()&&!d.notAuthorized&&(d.currentUser.meta.fb_user_id=null,d.getFB().logout())},getFbUserId:function(){return d.currentUser.meta.fb_user_id},onStatusChanged:function(a){"connected"===a.status?d.getFbUserId()!==a.authResponse.userID&&d.onFbLogin(a):"not_authorized"===a.status?d.notAutorized=!0:d.notAutorized=!0},onLoginButtonClicked:function(a){a&&a.preventDefault(),d.getFB().login(function(a){},{scope:"public_profile,email"})},onFbLogin:function(b){console.dir({FBResponse:b}),a.post("/api/facebook/login",b.authResponse,{spinner:!1,showMessage:!1,errorMessage:c._("message_error_auth_failed"),success:function(a){d.$scope.$emit("Chayka.Users.currentUserChanged",a.payload)},complete:function(a){}})}};return b.Facebook=d,d}]).directive("authFacebookButton",["facebook",function(a){var b=angular.element;return{restrict:"A",link:function(c,d){a.getFB(),a.$scope=c,b(document).on("logout",a.logout),b(d).click(a.onLoginButtonClicked),c.$on("Chayka.Users.currentUserChanged",function(a){console.dir({"Facebook.currentUserChanged":a})})}}}]);