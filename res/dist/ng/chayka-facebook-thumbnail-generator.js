"use strict";angular.module("chayka-facebook-thumbnail-generator",["chayka-forms","chayka-nls","chayka-wp-admin","chayka-utils"]).directive("facebookThumbnailGenerator",["utils",function(a){return{restrict:"A",replace:!0,templateUrl:a.getResourceUrl("facebook","ng/chayka-facebook-thumbnail-generator.html"),scope:{model:"=",blocks:"=?",fonts:"=?",defaultFont:"=?",defaultBackground:"=?",defaultLogo:"=?",postId:"@?",mode:"=?",thumbnailWidth:"=?",thumbnailHeight:"=?"},controller:["$scope","$element","$timeout",function(b,c,d){angular.extend(b,{blockControls:{},tab:"background",modalTabPicker:null,thumbnailWidth:b.thumbnailWidth||600,thumbnailHeight:b.thumbnailHeight||315,init:function(){b.initModel(),b.$watch("model",function(){b.initModel(),d(function(){b.$apply()},0)})},initModel:function(){b.model=a.setObjectDefaults(b.model,{background:{url:""},logo:{url:"",x:0,unitX:"px",y:0,unitY:"px",width:100,unitWidth:"px",anchor:"left-top"},fade:{backgroundColor:"#000000",backgroundOpacity:50}});for(var c in b.blocks)b.blocks.hasOwnProperty(c)&&(b.model[c]=b.model[c]||{})},getThumbnailElement:function(a){return c.find(".thumbnail_preview ."+a)},getModelImageUrl:function(a,b){return"default"===a.imageMode?b:a.url},getBlockStyle:function(a){var c=b.blockControls[a]&&b.blockControls[a].getBlockStyle()||{};if("background"===a){var d=b.getModelImageUrl(b.model.background,b.defaultBackground);c["background-image"]=d&&"url("+d+")"}return c},getBlockText:function(a){var c=b.blocks[a].text||"";return Array.isArray(c)?c.join(", "):c},getCanvasStyle:function(){return{height:b.model.background&&b.model.background.url?c.find(".thumbnail_preview .preview_background").height()+"px":"315px"}},activateTab:function(a){b.tab=a},isTabActive:function(a){return a===b.tab},isTabVisible:function(a){var c=b.model[a]&&b.model[a].active;return b.blocks[a].type&&b.model.type?c&&b.blocks[a].type===b.model.type:c},addBlockClicked:function(a){if(a){var c={x:0,unitX:"px",y:0,unitY:"px",width:50,unitWidth:"%",anchor:"left-top",fontFamily:"default",fontSize:20,color:"#ffffff",textAlign:"left",backgroundColor:"#000000",backgroundOpacity:0,borderColor:"#ffffff",borderWidth:0,borderWidthTop:0,borderWidthRight:0,borderWidthBottom:0,borderWidthLeft:0,padding:0,paddingTop:0,paddingRight:0,paddingBottom:0,paddingLeft:0};b.model[a]=b.model[a]||c,b.model[a].active=!0}else b.modalTabPicker.show()},getBlocksAvailable:function(){var a={};for(var c in b.blocks)!b.blocks.hasOwnProperty(c)||b.model[c]&&b.model[c].active||b.blocks[c].type&&b.model.type&&b.blocks[c].type!==b.model.type||(a[c]=b.blocks[c]);return a}}),b.init()}],link:function(a,b,c){}}}]).directive("facebookAnchorPicker",[function(){return{restrict:"A",replace:!0,template:'<div class="facebook-anchor_picker {{value}}" data-ng-click="pickAnchor($event)"></div>',scope:{value:"=",onChange:"&?"},controller:["$scope","$element",function(a,b){angular.extend(a,{value:a.value||"left-top",pickAnchor:function(c){var d=b.width()/3,e=b.height()/3,f=Math.ceil(c.offsetX/d),g=Math.ceil(c.offsetY/e),h="left",i="top";switch(f){case 1:h="left";break;case 2:h="center";break;case 3:h="right"}switch(g){case 1:i="top";break;case 2:i="center";break;case 3:i="bottom"}var j=h+"-"+i,k=j!==a.value;a.value=j,a.onChange&&k&&a.onChange()}})}]}}]).directive("facebookThumbnailBlockControl",["utils",function(a){return{restrict:"A",replace:!0,templateUrl:a.getResourceUrl("facebook","ng/chayka-facebook-thumbnail-block-control.html"),scope:{api:"=?facebookThumbnailBlockControl",model:"=",block:"@",optional:"@?",title:"@",tabsStr:"@tabs",imageHint:"@?",text:"=?",fonts:"=?",defaultImage:"=?",defaultFont:"=?"},controller:["$scope",function(b){angular.extend(b,{tabs:b.tabsStr&&b.tabsStr.split(/\s+/)||[],units:["px","%"],anchors:{"left-top":"Top Left","center-top":"Top Center","right-top":"Top Right","left-center":"Center Left","center-center":"Center","right-center":"Center Right","left-bottom":"Bottom Left","center-bottom":"Bottom Center","right-bottom":"Bottom Right"},init:function(){b.tab=b.tabs[0],b.initModel(),b.$watch("model",b.initModel)},initModel:function(){b.isTabShown("position")&&a.setObjectDefaults(b.model,{x:0,unitX:"px",y:0,unitY:"px",width:50,unitWidth:"%",anchor:"left-top"}),b.isTabShown("text")&&a.setObjectDefaults(b.model,{fontFamily:"default",fontSize:20,color:"#ffffff",textAlign:"left",textTransform:"none"}),b.isTabShown("box")&&a.setObjectDefaults(b.model,{backgroundColor:"#000000",backgroundOpacity:0,borderColor:"#ffffff",borderWidth:0,borderWidthTop:0,borderWidthRight:0,borderWidthBottom:0,borderWidthLeft:0,padding:0,paddingTop:0,paddingRight:0,paddingBottom:0,paddingLeft:0})},isTabShown:function(a){return b.tabs.indexOf(a)>=0},hashColorAndOpacityToRGB:function(a,b){a=a.replace("#",""),3===a.length&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]);var c=parseInt(a.substring(0,2),16),d=parseInt(a.substring(2,4),16),e=parseInt(a.substring(4,6),16);return"rgba("+c+","+d+","+e+","+b/100+")"},convertBlockStyle:function(){var c=b.$parent.getThumbnailElement(b.block),d=c.position(),e=b.model,f=d.left,g=a.getItem(e,"unitX","px"),h=d.top,i=a.getItem(e,"unitY","px"),j=c.outerWidth(),k=c.outerHeight(),l=a.getItem(e,"unitWidth","%"),m=a.getItem(e,"anchor","left-top"),n=c.parent().width(),o=c.parent().height();switch(m){default:case"left-top":break;case"center-top":f+=Math.floor(j/2);break;case"right-top":f+=Math.floor(j);break;case"left-center":h+=Math.floor(k/2);break;case"center-center":f+=Math.floor(j/2),h+=Math.floor(k/2);break;case"right-center":f+=Math.floor(j),h+=Math.floor(k/2);break;case"left-bottom":h+=k;break;case"center-bottom":f+=Math.floor(j/2),h+=k;break;case"right-bottom":f+=Math.floor(j),h+=Math.floor(k/2)}var p="%"===i?Math.round(h/o*100):h,q="%"===g?Math.round(f/n*100):f,r="%"===l?Math.round(j/n*100):j;angular.extend(b.model,{x:q,y:p,width:r})},getBlockStyle:function(){var c=b.$parent.getThumbnailElement(b.block),d=b.model,e={};if(!d)return{visibility:"hidden"};if(b.isTabShown("text")){var f="default"===d.fontFamily?b.defaultFont:d.fontFamily;angular.extend(e,{"font-family":f||"inherit","font-size":d.fontSize?d.fontSize+"px":"1em",color:d.color||"#FFFFFF","text-align":d.textAlign,"text-transform":d.textTransform})}if(b.isTabShown("position")){var g=a.getItem(d,"x",0),h=a.getItem(d,"unitX","px"),i=a.getItem(d,"y",0),j=a.getItem(d,"unitY","px"),k=a.getItem(d,"width",50),l=a.getItem(d,"unitWidth","%"),m=a.getItem(d,"anchor","left-top"),n=c.outerWidth(),o=c.outerHeight(),p=n/o,q=c.parent().width(),r=c.parent().height(),s="%"===j?Math.round(i/100*r):i,t="%"===h?Math.round(g/100*q):g,u="%"===l?Math.round(k/100*q):k,v=Math.round(u/p);switch(m){default:case"left-top":break;case"center-top":t-=Math.floor(u/2);break;case"right-top":t-=Math.floor(u);break;case"left-center":s-=Math.floor(v/2);break;case"center-center":t-=Math.floor(u/2),s-=Math.floor(v/2);break;case"right-center":t-=Math.floor(u),s-=Math.floor(v/2);break;case"left-bottom":s-=v;break;case"center-bottom":t-=Math.floor(u/2),s-=v;break;case"right-bottom":t-=Math.floor(u),s-=Math.floor(v/2)}angular.extend(e,{top:s,left:t,width:u})}if(b.isTabShown("box")){var w=d.borderWidth&&d.borderWidth+"px"||"0",x=[];d.borderWidth<0&&(x.push((d.borderWidthTop&&d.borderWidthTop+"px"||0)+""),x.push((d.borderWidthRight&&d.borderWidthRight+"px"||0)+""),x.push((d.borderWidthBottom&&d.borderWidthBottom+"px"||0)+""),x.push((d.borderWidthLeft&&d.borderWidthLeft+"px"||0)+""),w=x.join(" "));var y=d.padding&&d.padding+"px"||"0",z=[];d.borderWidth<0&&(z.push((d.paddingTop&&d.paddingTop+"px"||0)+""),z.push((d.paddingRight&&d.paddingRight+"px"||0)+""),z.push((d.paddingBottom&&d.paddingBottom+"px"||0)+""),z.push((d.paddingLeft&&d.paddingLeft+"px"||0)+""),y=z.join(" ")),angular.extend(e,{"background-color":b.hashColorAndOpacityToRGB(d.backgroundColor||"#000",d.backgroundOpacity||0),border:"solid "+d.borderColor,"border-width":w,padding:y})}return b.optional&&(e=d.active?angular.extend(e,{visibility:"visible"}):{visibility:"hidden"}),e},switchComplexity:function(a){var c=b.model;c[a]>=0?(c[a+"Top"]=c[a],c[a+"Right"]=c[a],c[a+"Bottom"]=c[a],c[a+"Left"]=c[a],c[a]=-1):c[a]=Math.max(c[a+"Top"],c[a+"Right"],c[a+"Bottom"],c[a+"Left"])},renderBlock:function(){}}),b.init(),b.api={getBlockStyle:b.getBlockStyle}}]}}]);